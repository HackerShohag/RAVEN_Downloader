clickable_minimum_required: 8.0.0
builder: cmake
kill: qmlscene

framework: ubuntu-touch-24.04-1.x

image_setup:
  run:
    - apt update
    - apt install -y python3-pip build-essential yasm nasm pkg-config

ignore_review_warnings: true
ignore_review_errors: true

# Post-build script to install yt-dlp as embedded Python library and build ffmpeg from source
postbuild: |
  set -ex
  echo "=== Starting postbuild: Installing yt-dlp and building ffmpeg ==="

  # Find the install directory
  if [ -n "$INSTALL_DIR" ]; then
    TARGET_DIR="$INSTALL_DIR"
  elif [ -n "$CMAKE_INSTALL_PREFIX" ]; then
    TARGET_DIR="$CMAKE_INSTALL_PREFIX"
  else
    TARGET_DIR="./build/all/app/install"
  fi

  echo "Target directory: $TARGET_DIR"
  echo "Creating lib/python3/dist-packages directory..."
  mkdir -p "$TARGET_DIR/lib/python3/dist-packages"
  
  echo "Installing yt-dlp..."
  pip3 install --target="$TARGET_DIR/lib/python3/dist-packages" --upgrade --no-warn-script-location yt-dlp
  
  echo "=== Building ffmpeg from source ==="
  mkdir -p "$TARGET_DIR/bin"
  mkdir -p "$TARGET_DIR/lib"
  mkdir -p "$TARGET_DIR/include"
  # mkdir -p "$TARGET_DIR/opt"
  
  FFMPEG_VERSION="8.0.1"
  FFMPEG_URL="https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
  BUILD_DIR="/tmp/ffmpeg-build"
  
  # Download ffmpeg source
  echo "Downloading ffmpeg ${FFMPEG_VERSION} from: $FFMPEG_URL"
  wget -q -O /tmp/ffmpeg-${FFMPEG_VERSION}.tar.xz "$FFMPEG_URL"
  if [ $? -ne 0 ]; then
    echo "ERROR: Failed to download ffmpeg source"
    exit 1
  fi
  
  # Extract source
  echo "Extracting ffmpeg source..."
  mkdir -p "$BUILD_DIR"
  tar -xJf /tmp/ffmpeg-${FFMPEG_VERSION}.tar.xz -C "$BUILD_DIR" --strip-components=1
  
  # Configure and build ffmpeg
  echo "Configuring ffmpeg..."
  cd "$BUILD_DIR"
  
  # Detect target architecture from ARCH or ARCH_TRIPLET
  if [ -n "$ARCH" ]; then
    TARGET_ARCH="$ARCH"
  elif [ -n "$ARCH_TRIPLET" ]; then
    TARGET_ARCH="$ARCH_TRIPLET"
  else
    TARGET_ARCH="arm64"
  fi
  
  echo "Cross-compiling ffmpeg for architecture: $TARGET_ARCH"
  
  # Configure for cross-compilation based on architecture
  ARCH_CONFIG=""
  case "$TARGET_ARCH" in
    *aarch64*|*arm64*)
      echo "Configuring for ARM64/AARCH64"
      ARCH_CONFIG="--arch=aarch64 --enable-cross-compile --cross-prefix=aarch64-linux-gnu- --target-os=linux"
      ;;
    *armhf*|*armv7*)
      echo "Configuring for ARMHF/ARMv7"
      ARCH_CONFIG="--arch=arm --cpu=armv7-a --enable-cross-compile --cross-prefix=arm-linux-gnueabihf- --target-os=linux"
      ;;
    *amd64*|*x86_64*)
      echo "Configuring for AMD64/x86_64"
      ARCH_CONFIG="--arch=x86_64"
      ;;
    *)
      echo "WARNING: Unknown architecture $TARGET_ARCH, building for host"
      ARCH_CONFIG=""
      ;;
  esac

  ./configure --prefix="$TARGET_DIR" --bindir="$TARGET_DIR/bin" --libdir="$TARGET_DIR/lib" $ARCH_CONFIG --enable-shared --enable-gpl --enable-small --disable-doc --disable-htmlpages --disable-manpages --disable-podpages --disable-txtpages --disable-debug --disable-static --disable-programs --enable-ffmpeg --enable-ffprobe
  
  if [ $? -ne 0 ]; then
    echo "ERROR: ffmpeg configuration failed"
    exit 1
  fi
  
  echo "Building ffmpeg (this may take a while)..."
  make -j$(nproc)
  
  if [ $? -ne 0 ]; then
    echo "ERROR: ffmpeg build failed"
    exit 1
  fi
  
  echo "Installing ffmpeg..."
  make install
  
  if [ $? -ne 0 ]; then
    echo "ERROR: ffmpeg installation failed"
    exit 1
  fi
  
  # Verify installation
  echo "Verifying ffmpeg installation..."
  if [ -f "$TARGET_DIR/bin/ffmpeg" ]; then
    chmod +x "$TARGET_DIR/bin/ffmpeg"
    echo "ffmpeg binary installed to $TARGET_DIR/bin/ffmpeg"
    
    # Verify architecture of built binaries
    echo "Verifying architecture of built binaries:"
    file "$TARGET_DIR/bin/ffmpeg"
    if [ -f "$TARGET_DIR/lib/libavcodec.so" ]; then
      file "$TARGET_DIR/lib/libavcodec.so"
    fi
    
    # Set library path for verification
    export LD_LIBRARY_PATH="$TARGET_DIR/lib:${LD_LIBRARY_PATH:-}"
    "$TARGET_DIR/bin/ffmpeg" -version || echo "WARNING: ffmpeg binary may not be functional"
  else
    echo "ERROR: ffmpeg binary not found after installation"
    exit 1
  fi
  
  # Cleanup
  echo "Cleaning up build files..."
  rm -rf "$BUILD_DIR" /tmp/ffmpeg-${FFMPEG_VERSION}.tar.xz
  
  echo "=== yt-dlp installed successfully to $TARGET_DIR/lib/python3/dist-packages ==="
  echo "=== ffmpeg built and installed successfully ==="
  echo "=== Postbuild complete ==="
